# システムアーキテクチャ

## 概要

技術情報を自動収集し、AIで分類・要約して配信するシステム。

## 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 n8n Workflows                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  【Fetch RSS WF】           【Process RSS Articles WF】    【Send WF】           │
│  Schedule: 定期実行         (サブワークフロー)              Schedule: 定期実行   │
│                                                                                 │
│  ┌──────────────┐          ┌───────────────────┐         ┌──────────────────┐  │
│  │Schedule      │          │Execute WF Trigger │         │Schedule Trigger  │  │
│  │Trigger       │          └─────────┬─────────┘         └────────┬─────────┘  │
│  └──────┬───────┘                    │                            │            │
│         ▼                            ▼                            ▼            │
│  ┌──────────────┐          ┌───────────────────┐         ┌──────────────────┐  │
│  │Get Active    │          │Normalize RSS Data │         │Get Articles      │  │
│  │Feed Sources  │          └─────────┬─────────┘         │(カテゴリ別)       │  │
│  └──────┬───────┘                    ▼                   └────────┬─────────┘  │
│         ▼                  ┌───────────────────┐                  ▼            │
│  ┌──────────────┐          │Check Duplicate    │         ┌──────────────────┐  │
│  │Loop Feed     │          └─────────┬─────────┘         │Aggregate         │  │
│  │Sources       │                    ▼                   │Articles          │  │
│  └──────┬───────┘          ┌───────────────────┐         └────────┬─────────┘  │
│         ▼                  │Analyze with AI    │                  ▼            │
│  ┌──────────────┐          │(OpenAI)           │         ┌──────────────────┐  │
│  │Fetch RSS     │          │・カテゴリ判定      │         │Generate          │  │
│  │Feed          │          │・キーワード抽出    │         │Message (AI)      │  │
│  └──────┬───────┘          │・要約生成         │         └────────┬─────────┘  │
│         ▼                  │・タイトル翻訳      │                  ▼            │
│  ┌──────────────┐          └─────────┬─────────┘         ┌──────────────────┐  │
│  │Process RSS   │──────────►        ▼                   │Send Message      │  │
│  │Articles      │          ┌───────────────────┐         └──────────────────┘  │
│  │(サブWF呼出)   │          │Save Article       │                              │
│  └──────┬───────┘          │(Supabase保存)     │                              │
│         ▼                  └───────────────────┘                              │
│  ┌──────────────┐                                                              │
│  │Notify        │                                                              │
│  │Completion    │                                                              │
│  └──────────────┘                                                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             Supabase (PostgreSQL)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│  feed_sources / articles                                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント

### n8n Workflows

#### Tech News Collector - Fetch RSS（メインワークフロー）
- **実行間隔**: 定期実行
- **処理内容**:
  1. DBからアクティブなRSSフィードソースを取得
  2. 各フィードをループで処理
  3. RSS取得・パース
  4. サブワークフロー（Process RSS Articles）を呼び出し
  5. 完了後通知

#### Tech News Collector - Process RSS Articles（サブワークフロー）
- **呼び出し元**: Fetch RSS
- **処理内容**:
  1. 記事データを正規化
  2. 重複チェック（guidベース）
  3. OpenAI でカテゴリ判定・キーワード抽出・要約・タイトル翻訳
  4. Supabaseに保存

#### Tech News Collector - Send Slack (*)（配信ワークフロー）
- **実行間隔**: 定期実行
- **処理内容**:
  1. 直近に取得したカテゴリ別記事を取得
  2. 記事情報を集約
  3. AIでトレンド要約・おすすめ記事を生成
  4. 配信先に送信

### Supabase
- **用途**: データベース（PostgreSQL）
- **リージョン**: ap-northeast-1（東京）

### AI (OpenAI)
- **用途**:
  - カテゴリ自動分類（13種類、複数選択可）
  - キーワード抽出（3〜5個）
  - 記事要約（日本語、200〜300字）
  - 英語記事のタイトル翻訳
  - 配信用トレンド要約生成

## 設計上の重要な決定事項

1. **サブワークフロー分離**: Split In Batchesのネスト問題を回避するため、記事処理をサブワークフローに分離
2. **重複チェック**: guidベースで重複を判定
3. **タイトル翻訳**: 英語記事は日本語に翻訳し、元のタイトルはoriginal_titleに保存
4. **カテゴリ配列**: 1記事に複数カテゴリ（最大3つ）を割り当て可能
5. **配信ワークフロー**: カテゴリ別に独立したワークフローで配信（拡張性確保）
6. **fetched_atベースのフィルタ**: 配信時は`published_at`ではなく`fetched_at`で絞り込み（新規取得記事のみ配信）
